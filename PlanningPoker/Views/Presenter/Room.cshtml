@model string

@{
    ViewBag.Title = "Room";
}

<h2>Room @Model</h2>

<div data-bind="foreach: players">
    <section class="hand" data-bind="css: { pick: card }">
        <div class="card">
            <figure class="front"></figure>
        </div><div class="card">
            <figure class="front"></figure>
        </div><div class="card">
            <figure class="front"></figure>
            <figure class="back" data-bind="text: card"></figure>
        </div><div class="card">
            <figure class="front"></figure>
        </div><div class="card">
            <figure class="front"></figure>
        </div>
        <div class="name" data-bind="text: name"></div>
    </section>
</div>

<br />
<br />
<button id="reset" data-bind="click: reset">Reset</button>
@section scripts {
    <script src="~/Scripts/room.js"></script>
    <script src="~/Scripts/knockout-3.4.0.js"></script>
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <script src="~/signalr/hubs"></script>
    
    <script>
        $(function () {
            
            // Reference the auto-generated proxy for the hub.
            var pokerHubProxy = $.connection.pokerHub;
            // Create a function that the hub can call back to display messages.
            pokerHubProxy.state.room = "@Model";

            ko.applyBindings(new RoomViewModel(pokerHubProxy));

            $.connection.hub.start().done(function () {
                pokerHubProxy.server.createRoom();
            });

            function RoomViewModel(pokerHubProxy) {
                var self = this;

                self.players = ko.observableArray([]);
                
                self.reset = function () {
                    $('.hand').removeClass('flip').removeClass('pick');
                    for (var i = 0; i < self.players().length; i++) {
                        self.players()[i].card("");
                    }
                }

                pokerHubProxy.client.playerJoined = function (name, connectionId) {
                    self.players.push(new Player(name, connectionId));
                }

                pokerHubProxy.client.picked = function (name, connectionId, card) {
                    for (var i = 0; i < self.players().length; i++) {
                        if (self.players()[i].connectionId == connectionId) {
                            self.players()[i].card(card);
                        }
                    }

                    var flip = true;
                    for (var i = 0; i < self.players().length; i++) {
                        if (self.players()[i].card() == "") {
                            flip = false;
                            break;
                        }
                    }
                    if (flip) {
                        setTimeout(function () { $('.hand').addClass('flip'); }, 2000);
                    }
                };
            }

            function Player(name, connectionId) {
                var self = this;
                self.name = name;
                self.connectionId = connectionId;
                self.card = ko.observable("");
            }

        });

    </script>
}
